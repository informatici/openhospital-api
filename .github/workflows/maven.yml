# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Checkout core
        run: git clone --depth=50 --branch=develop https://github.com/informatici/openhospital-core.git openhospital-core

      - name: Install core
        run: cd openhospital-core && mvn install -DskipTests=true && cd ..

      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Build with Maven
        run: mvn -B package --file pom.xml

      - name: Store branch name
        id: extract_branch
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            echo "{branch}=$(echo ${GITHUB_REF##*/})" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            echo "{branch}=$(echo $GITHUB_BASE_REF)" >> $GITHUB_OUTPUT
          else
            echo "{branch}=INVALID_EVENT_BRANCH_UNKNOWN" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate OpenAPI yaml
        run: mvn springdoc-openapi:generate
        
       # Uncomment to have also json 
#      - name: Convert yaml to json
#        uses: mikefarah/yq@master
#        with:
#          cmd: yq -p yaml -o json openapi/oh.yaml > openapi/oh.json

      - name: Update PR with OpenAPI specs changes (if any)
        uses: gr2m/create-or-update-pull-request-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          commit-message: "GitHub Action: update openapi"
          path: "openapi"
          branch: ${{ steps.extract_branch.outputs.branch }}